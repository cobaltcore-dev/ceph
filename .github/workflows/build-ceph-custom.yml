name: Build Ceph CobaltCore (Squid)

on:
  workflow_dispatch:
    inputs:
      cherry_pick_commits:
        description: 'List of Commit Hashes to cherry-pick (space separated)'
        required: false
        type: string
      merge_branches:
        description: 'List of Branches to merge (space separated)'
        required: false
        type: string
      base_branch:
        description: 'Base branch to build from'
        required: true
        default: 'squid-cobaltcore'
      push_image:
        description: 'Push image to GitHub Packages?'
        type: boolean
        default: true

jobs:
  build-ceph:
    name: Build Ceph
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write

    steps:
      # --- 1. CHECKOUT & PREPARE ---
      - name: Checkout CobaltCore Ceph
        uses: actions/checkout@v4
        with:
          repository: cobaltcore-dev/ceph
          ref: ${{ inputs.base_branch }}
          submodules: recursive
          fetch-depth: 0

      - name: Clean Workspace
        run: |
          echo "Cleaning workspace..."
          git clean -fdx
          git submodule foreach --recursive git clean -fdx
          git submodule update --init --recursive

      - name: Setup Remotes (Upstream)
        run: |
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/ceph/ceph.git
          git fetch upstream

      # --- 2. APPLY CUSTOM CHANGES ---
      - name: Apply Cherry-Picks and Merges
        if: "${{ inputs.cherry_pick_commits != '' || inputs.merge_branches != '' }}"
        run: |
          git config user.email "ci-bot@cobaltcore.dev"
          git config user.name "CobaltCore CI"

          # Merge Branches
          BRANCHES="${{ inputs.merge_branches }}"
          if [ ! -z "$BRANCHES" ]; then
            for BRANCH in $BRANCHES; do
              echo "Merging branch: $BRANCH"
              if git rev-parse --verify "origin/$BRANCH" >/dev/null 2>&1; then
                git merge --no-edit "origin/$BRANCH"
              elif git rev-parse --verify "upstream/$BRANCH" >/dev/null 2>&1; then
                git merge --no-edit "upstream/$BRANCH"
              else
                echo "Error: Branch '$BRANCH' not found!"
                exit 1
              fi
            done
          fi

          # Cherry-Pick Commits
          COMMITS="${{ inputs.cherry_pick_commits }}"
          if [ ! -z "$COMMITS" ]; then
            for COMMIT in $COMMITS; do
              echo "Cherry-picking commit: $COMMIT"
              if ! git cat-file -t $COMMIT >/dev/null 2>&1; then
                git fetch upstream $COMMIT
              fi
              git cherry-pick $COMMIT
            done
          fi

      # --- 3. PATCH BUILDER SCRIPT ---
      - name: Patch Builder Script
        run: |
          sed -i 's/dnf install -y \/usr\/bin\/rpmbuild/dnf install -y --allowerasing \/usr\/bin\/rpmbuild/g' src/script/buildcontainer-setup.sh

      # --- 4. COMPILE CEPH ---
      - name: Compile RPMs
        run: |
          CORE_COUNT=$(nproc)
          MEM_GB=$(free -g | awk '/^Mem:/{print $2}')
          JOBS=$((MEM_GB / 2))
          [[ $JOBS -lt 2 ]] && JOBS=2
          [[ $JOBS -gt $CORE_COUNT ]] && JOBS=$CORE_COUNT
          export NINJAJOBS=$JOBS

          ./src/script/build-with-container.py \
            -d centos9 \
            -e rpm \
            -- \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DENABLE_LTO=OFF \
            -DWITH_TESTS=OFF

      # --- 5. OPTIMIZE (SLIM DOWN) ---
      - name: Filter RPMs
        run: |
          rm -rf staging_rpms
          mkdir -p staging_rpms
          find rpmbuild/RPMS -name "*.rpm" \
            ! -name "*debuginfo*" ! -name "*debugsource*" \
            ! -name "*devel*" ! -name "*test*" ! -name "*static*" \
            -exec cp {} staging_rpms/ \;
            
          echo "RPMs to be installed:"
          ls -lh staging_rpms/

      # --- 6. BUILD & PUSH (PODMAN NATIVE) ---
      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM quay.io/centos/centos:stream9
          RUN dnf install -y epel-release && /usr/bin/crb enable && dnf makecache
          RUN dnf install -y lvm2 python3 python3-pyyaml libibverbs librdmacm \
              libicu libaio nss nspr cryptsetup lua-devel && dnf clean all
          COPY staging_rpms/*.rpm /tmp/rpms/
          RUN dnf localinstall -y /tmp/rpms/*.rpm --skip-broken --setopt=install_weak_deps=False && \
              dnf clean all && rm -rf /tmp/rpms
          RUN mkdir -p /var/run/ceph /var/lib/ceph /var/log/ceph && \
              chmod 770 /var/run/ceph /var/lib/ceph /var/log/ceph
          ENTRYPOINT ["/usr/bin/ceph"]
          EOF

      - name: Set Image Tag
        run: echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Build Image (Podman)
        run: |
          # Build using native Podman
          echo "Building image..."
          podman build -t ghcr.io/${{ env.REPO_LOWER }}:squid-cobaltcore -f Dockerfile .
          
          # Tag 'latest' as well
          podman tag ghcr.io/${{ env.REPO_LOWER }}:squid-cobaltcore ghcr.io/${{ env.REPO_LOWER }}:latest

      - name: Push to GitHub Packages
        if: ${{ inputs.push_image }}
        run: |
          echo "Logging into ghcr.io..."
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin
          
          echo "Pushing images..."
          podman push ghcr.io/${{ env.REPO_LOWER }}:squid-cobaltcore
          podman push ghcr.io/${{ env.REPO_LOWER }}:latest
          

